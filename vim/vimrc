silent function! s:WINDOWS()
    return (has("win32") || has("win64"))
endfunction

silent function! s:LINUX()
    return (has('unix') && !has('macunix') && !has('win32unix'))
endfunction

silent function! s:NVIM()
    return (has('nvim'))
endfunction

silent function! s:ASYNC()
    return ((v:version >= 800) || s:NVIM())
endfunction

if s:LINUX()
    if s:NVIM()
        let VIM_PLUG_HOME = '~/.config/nvim/plugged'
    else
        let VIM_PLUG_HOME = '~/.vim/plugged'
    endif
else
    let VIM_PLUG_HOME = '~\vimfiles\plugged'
endif

call plug#begin(VIM_PLUG_HOME)

" plugins
Plug 'cohama/agit.vim'
Plug 'danro/rename.vim'
Plug 'hdima/python-syntax'
Plug 'hynek/vim-python-pep8-indent'
Plug 'itchyny/lightline.vim'
Plug 'jiajunhuang/vim-cython'
Plug 'jiangmiao/auto-pairs'
Plug 'junegunn/vim-easy-align'
Plug 'kshenoy/vim-signature'
Plug 'luochen1990/rainbow'
Plug 'neovimhaskell/haskell-vim'
Plug 'ntpeters/vim-better-whitespace'
Plug 'othree/eregex.vim'
Plug 'scrooloose/nerdcommenter'
Plug 'sessionman.vim'
Plug 'sickill/vim-monokai'
Plug 'terryma/vim-expand-region'
Plug 'terryma/vim-multiple-cursors'
Plug 'tpope/vim-repeat'
Plug 'tpope/vim-surround'

" Linux only
if s:LINUX()
    Plug 'Valloric/YouCompleteMe'
    Plug 'ctrlpvim/ctrlp.vim' | Plug 'tacahiroy/ctrlp-funky'
    Plug 'easymotion/vim-easymotion'
    Plug 'ludovicchabant/vim-gutentags' | Plug 'majutsushi/tagbar'
    Plug 'mileszs/ack.vim'
    Plug 'scrooloose/nerdtree' | Plug 'jistr/vim-nerdtree-tabs' | Plug 'Xuyuanp/nerdtree-git-plugin'
    Plug 'tpope/vim-fugitive'
    if s:ASYNC()
        Plug 'w0rp/ale'
    else
        Plug 'vim-syntastic/syntastic'
    endif
endif

if s:WINDOWS()
    Plug 'mhinz/vim-startify'
endif

call plug#end()

" settings

" Windows only
if s:WINDOWS()
    set encoding=utf-8
    set nobackup
    set fileencodings=utf-8,chinese,latin-1
    source $VIMRUNTIME/delmenu.vim
    source $VIMRUNTIME/menu.vim
    language messages zh_CN.UTF-8
    set guifont=Consolas:h14:cANSI
    set guioptions-=m  "remove menu bar
    set guioptions-=T  "remove toolbar
    set guioptions-=r  "remove right-hand scroll bar
    set guioptions-=L  "remove left-hand scroll bar
    set guioptions+=a  "auto copy mouse selection
    autocmd GUIEnter * set vb t_vb= "disable sound
    autocmd GUIEnter * simalt ~x " auto maximized window
endif

" Regular vim only
set nocompatible
set autoindent
set noundofile
set autoread
set backspace=indent,eol,start
set display=lastline
set encoding=utf-8
set history=10000
set hlsearch
set incsearch
set laststatus=2
set wildmenu

"syntax
syntax on
syntax enable
" display
set ignorecase
set ruler
set number
set showcmd
set showmode
set cursorline cursorcolumn
set cc=80
set wrap
set textwidth=0
"display pairs
set showmatch
"indent
set expandtab
set shiftwidth=4
set tabstop=4
set softtabstop=4
set cindent
set shiftround
"Tab
set smarttab
" colorscheme, default to monokai, fallback to desert
try
    colorscheme monokai
catch /^Vim\%((\a\+)\)\=:E185/
    colorscheme desert
endtry

" shortcuts
" import pdb
nnoremap <Leader>b Oimport pdb; pdb.set_trace()  # TODO remove it<Esc>:w<CR>

" paste mode
set pastetoggle=<F2>
" toggle number
noremap <F4> :set invnumber<CR>
inoremap <F4> <C-O>:set invnumber<CR>
" make mouse only works on command line mode
set mouse=c

" emacs key bindings for vim insert mode
inoremap <C-d> <Del>
inoremap <C-a> <Home>
inoremap <C-e> <End>
inoremap <C-f> <Right>
inoremap <C-b> <Left>

" plugin settings
" Rainbow
let g:rainbow_active = 1

" Linux only
if s:LINUX()
    "Ack
    nnoremap <Leader>a  :Ack!<Space>

    " NERDTree
    nnoremap <F1> :NERDTreeTabsToggle<CR>

    "easymotion
    let g:EasyMotion_do_mapping = 0 " Disable default mappings
    nmap s <Plug>(easymotion-bd-f)
    nmap S <Plug>(easymotion-overwin-line)

    " ctrlp && ctrlp-funky
    nnoremap ff :CtrlPFunky<Cr>
    let g:ctrlp_funky_matchtype = 'path'
    let g:ctrlp_custom_ignore = {
        \ 'dir':  '\.git$\|\.hg$\|\.svn$',
        \ 'file': '\.exe$\|\.so$\|\.dll$\|\.pyc$'
        \ }
    if executable("ag")
        let g:ctrlp_user_command = 'ag %s -l --nocolor -g ""'
        let g:ctrlp_use_caching = 0
    elseif executable("ack")
        let s:ctrlp_user_command= 'ack %s --nocolor -f'
        let g:ctrlp_use_caching = 0
    endif

    " Tagbar
    nnoremap <F3> :TagbarToggle<CR>

    " YouCompleteMe
    let g:ycm_collect_identifiers_from_tags_files = 1 " Let YCM read tags from Ctags file
    let g:ycm_seed_identifiers_with_syntax = 1 " Completion for programming language's keyword
    let g:ycm_complete_in_comments = 1 " Completion in comments
    let g:ycm_complete_in_strings = 1 " Completion in string
    nnoremap <leader>\ :YcmCompleter GoTo<CR>

    " Ack.vim
    if executable('ag')
        let g:ackprg = 'ag --vimgrep'
    endif

    if s:ASYNC()
        nmap <leader>p <Plug>(ale_previous_wrap)
        nmap <leader>n <Plug>(ale_next_wrap)
    endif
endif
